-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_thresholds_housing_conditions CASCADE;
CREATE VIEW results.social_vulnerability_thresholds_housing_conditions AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
CAST(SUM(a.number) AS NUMERIC) AS "BldNumT",
(CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) + (CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) + (CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) + 
(CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) AS "HousingT",

CAST(b.pop_ha AS NUMERIC) AS "Pop_ha",
CAST((CASE WHEN (CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) = 1 THEN b.pop_ha * b.censuspop ELSE 0 END) AS NUMERIC) AS "Pop_Ha_p",

CAST(b.bus_ha AS NUMERIC) AS "Bus_Ha",
CAST((CASE WHEN (CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) = 1 THEN b.bus_ha * b.censuspop ELSE 0 END) AS NUMERIC) AS "Bus_Ha_p",

CAST(b.pre_1975 AS NUMERIC) AS "Pre_1975",
CAST((CASE WHEN (CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) = 1 THEN b.pre_1975 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Pre_1975_p",

CAST(b.hshld_nsuit AS NUMERIC) AS "Hshld_Nsuit",
CAST((CASE WHEN (CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) = 1 THEN b.hshld_nsuit * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_Nsuit_p",

CAST(b.hshld_mntnage AS NUMERIC) AS "Hshld_MntnAge",
CAST((CASE WHEN (CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) = 1 THEN b.hshld_mntnage * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_MntnAge_p",

CAST(b.hshld_mntn1 AS NUMERIC) AS "Hshld_Mntn1",
CAST((CASE WHEN (CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) = 1 THEN b.hshld_mntn1 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_Mntn1_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.pop_ha,c.pop_ha,b.bus_ha,c.bus_ha,b.pre_1975,c.pre_1975,b.hshld_nsuit,c.hshld_nsuit,b.hshld_mntnage,c.hshld_mntnage,b.hshld_mntn1,c.hshld_mntn1,d.geom,d.geompoint;