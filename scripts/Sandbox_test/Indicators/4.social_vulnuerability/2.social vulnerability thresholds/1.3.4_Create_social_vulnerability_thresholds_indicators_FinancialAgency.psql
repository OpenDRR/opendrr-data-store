-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_thresholds_financial_agency CASCADE;
CREATE VIEW results.social_vulnerability_thresholds_financial_agency AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
(CASE WHEN c.shltr_gt30 >= 0.4084 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_lowdecile >= 0.6936 THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= 0.2887 THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= 0.464 THEN 1 ELSE 0 END) + 
(CASE WHEN c.work_parttime >= 0.5845 THEN 1 ELSE 0 END) + (CASE WHEN c.employ_inc >= 0.4275 THEN 1 ELSE 0 END) AS "AgencyT",

CAST(b.shltr_gt30 AS NUMERIC) AS "Shltr_GT30",
CAST((CASE WHEN (CASE WHEN c.shltr_gt30 >= 0.4084 THEN 1 ELSE 0 END) = 1 THEN b.shltr_gt30 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Shltr_GT30_p",

CAST(b.inc_lowdecile AS NUMERIC) AS "Inc_LowDecile",
CAST((CASE WHEN (CASE WHEN c.inc_lowdecile >= 0.6936 THEN 1 ELSE 0 END) = 1 THEN b.inc_lowdecile * b.censuspop ELSE 0 END) AS NUMERIC) AS "Inc_LowDecile_p",

CAST(b.unemployed AS NUMERIC) AS "Unemployed",
CAST((CASE WHEN (CASE WHEN c.unemployed >= 0.2887 THEN 1 ELSE 0 END) = 1 THEN b.unemployed * b.censuspop ELSE 0 END) AS NUMERIC) AS "Unemployed_p",

CAST(b.work_none AS NUMERIC) AS "Work_None",
CAST((CASE WHEN (CASE WHEN c.work_none >= 0.464 THEN 1 ELSE 0 END) = 1 THEN b.work_none * b.censuspop ELSE 0 END) AS NUMERIC) AS "Work_None_p",

CAST(b.work_parttime AS NUMERIC) AS "Work_Parttime",
CAST((CASE WHEN (CASE WHEN b.work_parttime >= 0.464 THEN 1 ELSE 0 END) = 1 THEN b.work_parttime * b.censuspop ELSE 0 END) AS NUMERIC) AS "Work_Parttime_p",

CAST(b.employ_inc AS NUMERIC) AS "Employ_Inc",
CAST((CASE WHEN (CASE WHEN c.employ_inc >= 0.4275 THEN 1 ELSE 0 END) = 1 THEN b.employ_inc * b.censuspop ELSE 0 END) AS NUMERIC) AS "Employ_Inc_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.shltr_gt30,c.shltr_gt30,b.inc_lowdecile,c.inc_lowdecile,b.unemployed,c.unemployed,b.work_none,c.work_none,b.work_parttime,c.work_parttime,b.employ_inc,c.employ_inc,d.geom,d.geompoint;