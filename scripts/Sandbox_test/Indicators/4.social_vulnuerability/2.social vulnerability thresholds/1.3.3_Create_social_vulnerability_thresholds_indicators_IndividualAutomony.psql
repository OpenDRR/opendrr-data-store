-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_thresholds_individual_autonomy CASCADE;
CREATE VIEW results.social_vulnerability_thresholds_individual_autonomy AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual autonomony
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
(CASE WHEN c.no_engfr >= 0.808 THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= 0.2405 THEN 1 ELSE 0 END) + (CASE WHEN c.age_gt65 >= 0.3136 THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= 0.378 THEN 1 ELSE 0 END) +
(CASE WHEN c.indigenous >= 0.2029 THEN 1 ELSE 0 END) + (CASE WHEN c.vis_min >= 0.4148 THEN 1 ELSE 0 END) AS "AutonomyT",

CAST(b.no_engfr AS NUMERIC) AS "No_EngFr",
CAST((CASE WHEN (CASE WHEN c.no_engfr >= 0.808 THEN 1 ELSE 0 END) = 1 THEN b.no_engfr * b.censuspop ELSE 0 END) AS NUMERIC) AS "No_EngFr_p",

CAST(b.nosec_school AS NUMERIC) AS "NoSec_School",
CAST((CASE WHEN (CASE WHEN c.nosec_school >= 0.2405 THEN 1 ELSE 0 END) = 1 THEN b.nosec_school * b.censuspop ELSE 0 END) AS NUMERIC) AS "NoSec_School_p",

CAST(b.age_gt65 AS NUMERIC) AS "Age_GT65",
CAST((CASE WHEN (CASE WHEN c.age_gt65 >= 0.3136 THEN 1 ELSE 0 END) = 1 THEN b.age_gt65 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Age_GT65_p",

CAST(b.age_lt6 AS NUMERIC) AS "Age_LT6",
CAST((CASE WHEN (CASE WHEN c.age_lt6 >= 0.378 THEN 1 ELSE 0 END) = 1 THEN b.age_lt6 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Age_LT6_p",

CAST(b.indigenous AS NUMERIC) AS "Indigenous",
CAST((CASE WHEN (CASE WHEN c.indigenous >= 0.2029 THEN 1 ELSE 0 END) = 1 THEN b.indigenous * b.censuspop ELSE 0 END) AS NUMERIC) AS "Indigenous_p",

CAST(b.vis_min AS NUMERIC) AS "Vis_Min",
CAST((CASE WHEN (CASE WHEN c.vis_min >= 0.4148 THEN 1 ELSE 0 END) = 1 THEN b.vis_min * b.censuspop ELSE 0 END) AS NUMERIC) AS "Vis_Min_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.no_engfr,c.no_engfr,b.nosec_school,c.nosec_school,b.age_gt65,c.age_gt65,b.age_lt6, c.age_lt6,b.indigenous,c.indigenous,b.vis_min,c.vis_min,d.geom,d.geompoint;