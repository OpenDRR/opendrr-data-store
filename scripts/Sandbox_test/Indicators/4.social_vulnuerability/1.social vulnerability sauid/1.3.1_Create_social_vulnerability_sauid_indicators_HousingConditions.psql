-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_housing_conditions CASCADE;
CREATE VIEW results.social_vulnerability_housing_conditions AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
CAST(SUM(a.number) AS NUMERIC) AS "BldNumT",

CAST(b.pop_ha AS NUMERIC) AS "Pop_ha",
CAST(c.pop_ha AS NUMERIC) AS "Pop_ha_n",
(CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) AS "Pop_ha_t",

CAST(b.bus_ha AS NUMERIC) AS "Bus_Ha",
CAST(c.bus_ha AS NUMERIC) AS "Bus_Ha_n",
(CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) AS "Bus_Ha_t",

CAST(b.pre_1975 AS NUMERIC) AS "Pre_1975",
CAST(c.pre_1975 AS NUMERIC) AS "Pre_1975_n",
(CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) AS "Pre_1975_t",

CAST(b.hshld_nsuit AS NUMERIC) AS "Hshld_Nsuit",
CAST(c.hshld_nsuit AS NUMERIC) AS "Hshld_Nsuit_n",
(CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) AS "Hshld_Nsuit_t",

CAST(b.hshld_mntnage AS NUMERIC) AS "Hshld_MntnAge",
CAST(c.hshld_mntnage AS NUMERIC) AS "Hshld_MntnAge_n",
(CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) AS "Hshld_MntnAge_t",

CAST(b.hshld_mntn1 AS NUMERIC) AS "Hshld_Mntn1",
CAST(c.hshld_mntn1 AS NUMERIC) AS "Hshld_Mntn1_n",
(CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) AS "Hshld_Mntn1_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.pop_ha,c.pop_ha,b.bus_ha,c.bus_ha,b.pre_1975,c.pre_1975,b.hshld_nsuit,c.hshld_nsuit,b.hshld_mntnage,c.hshld_mntnage,
b.hshld_mntn1,c.hshld_mntn1,d.geom,d.geompoint;