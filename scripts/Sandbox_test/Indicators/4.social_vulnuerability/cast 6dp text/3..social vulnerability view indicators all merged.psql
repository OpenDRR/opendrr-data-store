-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_housing_conditions_view CASCADE;
CREATE VIEW results_text.social_vulnerability_housing_conditions_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.censuspop AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "CensusPop",
CAST(CAST(CAST(ROUND(CAST(SUM(a.number) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "BldNumT",
(CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) + (CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) + (CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) + 
(CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) AS "HousingT",

CAST(CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pop_ha",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) = 1 THEN b.pop_ha * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pop_Ha_p",

CAST(CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Bus_Ha",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) = 1 THEN b.bus_ha * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Bus_Ha_p",

CAST(CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pre_1975",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) = 1 THEN b.pre_1975 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pre_1975_p",

CAST(CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Nsuit",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) = 1 THEN b.hshld_nsuit * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Nsuit_p",

CAST(CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_MntnAge",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) = 1 THEN b.hshld_mntnage * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_MntnAge_p",

CAST(CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Mntn1",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) = 1 THEN b.hshld_mntn1 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Mntn1_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.pop_ha,c.pop_ha,b.bus_ha,c.bus_ha,b.pre_1975,c.pre_1975,b.hshld_nsuit,c.hshld_nsuit,b.hshld_mntnage,c.hshld_mntnage,b.hshld_mntn1,c.hshld_mntn1,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_family_structure_view CASCADE;
CREATE VIEW results_text.social_vulnerability_family_structure_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.censuspop AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "CensusPop",
(CASE WHEN c.renter >= 0.1731 THEN 1 ELSE 0 END) + (CASE WHEN c.live_alone >= 0.3674 THEN 1 ELSE 0 END) + (CASE WHEN c.lonepar3kids >= 0.3099 THEN 1 ELSE 0 END) + 
(CASE WHEN c.fam_gt5 >= 0.2184 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) 
+ (CASE WHEN c.imm_lt5 >= 0.1421 THEN 1 ELSE 0 END) AS "FamilyT",

CAST(CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Renter",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.renter >= 0.1731 THEN 1 ELSE 0 END) = 1 THEN b.renter * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Renter_p",

CAST(CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Live_Alone",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.live_alone >= 0.3674 THEN 1 ELSE 0 END) = 1 THEN b.live_alone * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Live_Alone_p",

CAST(CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "LonePar3Kids",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.lonepar3kids >= 0.3099 THEN 1 ELSE 0 END) = 1 THEN b.lonepar3kids * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "LonePar3Kids_p",

CAST(CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Fam_GT5",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.fam_gt5 >= 0.2184 THEN 1 ELSE 0 END) = 1 THEN b.fam_gt5 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Fam_GT5_p",

CAST(CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Moved_LT1",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) = 1 THEN b.moved_lt1 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Moved_LT1_p",

CAST(CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Imm_LT5",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.imm_lt5 >= 0.1421 THEN 1 ELSE 0 END) = 1 THEN b.imm_lt5 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Imm_LT5_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.renter,c.renter,b.live_alone,c.live_alone,b.lonepar3kids,c.lonepar3kids,b.fam_gt5,c.fam_gt5,b.moved_lt1,c.moved_lt1,b.imm_lt5,c.imm_lt5,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_individual_autonomy_view CASCADE;
CREATE VIEW results_text.social_vulnerability_individual_autonomy_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual autonomony
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.censuspop AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "CensusPop",
(CASE WHEN c.no_engfr >= 0.808 THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= 0.2405 THEN 1 ELSE 0 END) + (CASE WHEN c.age_gt65 >= 0.3136 THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= 0.378 THEN 1 ELSE 0 END) +
(CASE WHEN c.indigenous >= 0.2029 THEN 1 ELSE 0 END) + (CASE WHEN c.vis_min >= 0.4148 THEN 1 ELSE 0 END) AS "AutonomyT",

CAST(CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "No_EngFr",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.no_engfr >= 0.808 THEN 1 ELSE 0 END) = 1 THEN b.no_engfr * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "No_EngFr_p",

CAST(CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "NoSec_School",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.nosec_school >= 0.2405 THEN 1 ELSE 0 END) = 1 THEN b.nosec_school * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "NoSec_School_p",

CAST(CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_GT65",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.age_gt65 >= 0.3136 THEN 1 ELSE 0 END) = 1 THEN b.age_gt65 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_GT65_p",

CAST(CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_LT6",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.age_lt6 >= 0.378 THEN 1 ELSE 0 END) = 1 THEN b.age_lt6 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_LT6_p",

CAST(CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Indigenous",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.indigenous >= 0.2029 THEN 1 ELSE 0 END) = 1 THEN b.indigenous * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Indigenous_p",

CAST(CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Vis_Min",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.vis_min >= 0.4148 THEN 1 ELSE 0 END) = 1 THEN b.vis_min * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Vis_Min_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.no_engfr,c.no_engfr,b.nosec_school,c.nosec_school,b.age_gt65,c.age_gt65,b.age_lt6, c.age_lt6,b.indigenous,c.indigenous,b.vis_min,c.vis_min,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_financial_agency_view CASCADE;
CREATE VIEW results_text.social_vulnerability_financial_agency_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.censuspop AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "CensusPop",
(CASE WHEN c.shltr_gt30 >= 0.4084 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_lowdecile >= 0.6936 THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= 0.2887 THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= 0.464 THEN 1 ELSE 0 END) + 
(CASE WHEN c.work_parttime >= 0.5845 THEN 1 ELSE 0 END) + (CASE WHEN c.employ_inc >= 0.4275 THEN 1 ELSE 0 END) AS "AgencyT",

CAST(CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Shltr_GT30",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.shltr_gt30 >= 0.4084 THEN 1 ELSE 0 END) = 1 THEN b.shltr_gt30 * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Shltr_GT30_p",

CAST(CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Inc_LowDecile",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.inc_lowdecile >= 0.6936 THEN 1 ELSE 0 END) = 1 THEN b.inc_lowdecile * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Inc_LowDecile_p",

CAST(CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Unemployed",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.unemployed >= 0.2887 THEN 1 ELSE 0 END) = 1 THEN b.unemployed * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Unemployed_p",

CAST(CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_None",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.work_none >= 0.464 THEN 1 ELSE 0 END) = 1 THEN b.work_none * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_None_p",

CAST(CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_Parttime",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN b.work_parttime >= 0.464 THEN 1 ELSE 0 END) = 1 THEN b.work_parttime * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_Parttime_p",

CAST(CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Employ_Inc",
CAST(CAST(CAST(ROUND(CAST((CASE WHEN (CASE WHEN c.employ_inc >= 0.4275 THEN 1 ELSE 0 END) = 1 THEN b.employ_inc * b.censuspop ELSE 0 END) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Employ_Inc_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.shltr_gt30,c.shltr_gt30,b.inc_lowdecile,c.inc_lowdecile,b.unemployed,c.unemployed,b.work_none,c.work_none,b.work_parttime,c.work_parttime,b.employ_inc,c.employ_inc,d.geom,d.geompoint;