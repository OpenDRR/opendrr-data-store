-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_housing_conditions CASCADE;
CREATE VIEW results_float.social_vulnerability_housing_conditions AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
b.censuspop AS "CensusPop",
SUM(a.number) AS "BldNumT",

b.pop_ha AS "Pop_ha",
c.pop_ha AS "Pop_ha_n",
(CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) AS "Pop_ha_t",

b.bus_ha AS "Bus_Ha",
c.bus_ha AS "Bus_Ha_n",
(CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) AS "Bus_Ha_t",

b.pre_1975 AS "Pre_1975",
c.pre_1975 AS "Pre_1975_n",
(CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) AS "Pre_1975_t",

b.hshld_nsuit AS "Hshld_Nsuit",
c.hshld_nsuit AS "Hshld_Nsuit_n",
(CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) AS "Hshld_Nsuit_t",

b.hshld_mntnage AS "Hshld_MntnAge",
c.hshld_mntnage AS "Hshld_MntnAge_n",
(CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) AS "Hshld_MntnAge_t",

b.hshld_mntn1 AS "Hshld_Mntn1",
c.hshld_mntn1 AS "Hshld_Mntn1_n",
(CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) AS "Hshld_Mntn1_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.pop_ha,c.pop_ha,b.bus_ha,c.bus_ha,b.pre_1975,c.pre_1975,b.hshld_nsuit,c.hshld_nsuit,b.hshld_mntnage,c.hshld_mntnage,
b.hshld_mntn1,c.hshld_mntn1,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_family_structure CASCADE;
CREATE VIEW results_float.social_vulnerability_family_structure AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
a.sauid AS "Sauid",
b.renter AS "Renter",
c.renter AS "Renter_n",
(CASE WHEN c.renter >= 0.1731 THEN 1 ELSE 0 END) AS "Renter_t",

b.live_alone AS "Live_Alone",
c.live_alone AS "Live_Alone_n",
(CASE WHEN c.live_alone >= 0.3674 THEN 1 ELSE 0 END) AS "Live_Alone_t",

b.lonepar3kids AS "LonePar3Kids",
c.lonepar3kids AS "LonePar3Kids_n",
(CASE WHEN c.lonepar3kids >= 0.3099 THEN 1 ELSE 0 END) AS "LonePar3Kids_t",

b.fam_gt5 AS "Fam_GT5",
c.fam_gt5 AS "Fam_GT5_n",
(CASE WHEN c.fam_gt5 >= 0.2184 THEN 1 ELSE 0 END) AS "Fam_GT5_t",

b.moved_lt1 AS "Moved_LT1",
c.moved_lt1 AS "Moved_LT1_n",
(CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) AS "Moved_LT1_t",

b.imm_lt5 AS "Imm_LT5",
c.imm_lt5 AS "Imm_LT5_n",
(CASE WHEN c.imm_lt5 >= 0.1421 THEN 1 ELSE 0 END) AS "Imm_LT5_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.renter,c.renter,b.live_alone,c.live_alone,b.lonepar3kids,c.lonepar3kids,b.fam_gt5,c.fam_gt5,b.moved_lt1,c.moved_lt1,b.imm_lt5,c.imm_lt5,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_individual_autonomy CASCADE;
CREATE VIEW results_float.social_vulnerability_individual_autonomy AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual autonomony
SELECT 
a.sauid AS "Sauid",
b.no_engfr AS "No_EngFr",
c.no_engfr AS "No_EngFr_n",
(CASE WHEN c.no_engfr >= 0.808 THEN 1 ELSE 0 END) AS "NoEngfr_t",

b.nosec_school AS "NoSec_School",
c.nosec_school AS "NoSec_School_n",
(CASE WHEN c.nosec_school >= 0.2405 THEN 1 ELSE 0 END) AS "NoSec_School_t",

b.age_gt65 AS "Age_GT65",
c.age_gt65 AS "Age_GT65_n",
(CASE WHEN c.age_gt65 >= 0.3136 THEN 1 ELSE 0 END) AS "Age_GT65_t",

b.age_lt6 AS "Age_LT6",
c.age_lt6 AS "Age_LT6_n",
(CASE WHEN c.age_lt6 >= 0.378 THEN 1 ELSE 0 END) AS "Age_LT65_t",

b.indigenous AS "Indigenous",
c.indigenous AS "Indigenous_n",
(CASE WHEN c.indigenous >= 0.2029 THEN 1 ELSE 0 END) AS "Indigenous_t",

b.vis_min AS "Vis_Min",
c.vis_min AS "Vis_Min_n",
(CASE WHEN c.vis_min >= 0.4148 THEN 1 ELSE 0 END) AS "Vis_Min_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.no_engfr,c.no_engfr,b.nosec_school,c.nosec_school,b.age_gt65,c.age_gt65,b.age_lt6, c.age_lt6,b.indigenous,c.indigenous,b.vis_min,c.vis_min,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_financial_agency CASCADE;
CREATE VIEW results_float.social_vulnerability_financial_agency AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Financial Agency
SELECT 
a.sauid AS "Sauid",
b.shltr_gt30 AS "Shltr_GT30",
c.shltr_gt30 AS "Shltr_GT30_n",
(CASE WHEN c.shltr_gt30 >= 0.4084 THEN 1 ELSE 0 END) AS "Shltr_GT30_t",

b.inc_lowdecile AS "Inc_LowDecile",
c.inc_lowdecile AS "Inc_LowDecile_n",
(CASE WHEN c.inc_lowdecile >= 0.6936 THEN 1 ELSE 0 END) AS "Inc_LowDecile_t",

b.unemployed AS "Unemployed",
c.unemployed AS "Unemployed_n",
(CASE WHEN c.unemployed >= 0.2887 THEN 1 ELSE 0 END) AS "Unemployed_t",

b.work_none AS "Work_None",
c.work_none AS "Work_None_n",
(CASE WHEN c.work_none >= 0.464 THEN 1 ELSE 0 END) AS "Work_None_t",

b.work_parttime AS "Work_Parttime",
c.work_parttime AS "Work_Parttime_n",
(CASE WHEN c.work_parttime >= 0.5845 THEN 1 ELSE 0 END) AS "Work_Parttime_t",

b.employ_inc AS "Employ_Inc",
c.employ_inc AS "Employ_Inc_n",
(CASE WHEN c.employ_inc >= 0.4275 THEN 1 ELSE 0 END) AS "Employ_Inc_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.shltr_gt30,c.shltr_gt30,b.inc_lowdecile,c.inc_lowdecile,b.unemployed,c.unemployed,b.work_none,c.work_none,b.work_parttime,c.work_parttime,b.employ_inc,c.employ_inc,d.geom,d.geompoint;