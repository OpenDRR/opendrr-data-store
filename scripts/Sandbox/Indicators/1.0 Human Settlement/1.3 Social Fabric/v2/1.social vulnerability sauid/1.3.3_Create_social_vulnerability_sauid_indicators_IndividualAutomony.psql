-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_individual_autonomy CASCADE;
CREATE VIEW results.social_vulnerability_individual_autonomy AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual autonomony
SELECT 
a.sauid AS "Sauid",
CAST(b.no_engfr AS NUMERIC) AS "No_EngFr",
CAST(c.no_engfr AS NUMERIC) AS "No_EngFr_n",
(CASE WHEN c.no_engfr >= 0.0859 THEN 1 ELSE 0 END) AS "NoEngfr_t",

CAST(b.nosec_school AS NUMERIC) AS "NoSec_School",
CAST(c.nosec_school AS NUMERIC) AS "NoSec_School_n",
(CASE WHEN c.nosec_school >= 0.2782 THEN 1 ELSE 0 END) AS "NoSec_School_t",

CAST(b.age_gt65 AS NUMERIC) AS "Age_GT65",
CAST(c.age_gt65 AS NUMERIC) AS "Age_GT65_n",
(CASE WHEN c.age_gt65 >= 0.3333 THEN 1 ELSE 0 END) AS "Age_GT65_t",

CAST(b.age_lt6 AS NUMERIC) AS "Age_LT6",
CAST(c.age_lt6 AS NUMERIC) AS "Age_LT6_n",
(CASE WHEN c.age_lt6 >= 0.4388 THEN 1 ELSE 0 END) AS "Age_LT65_t",

CAST(b.indigenous AS NUMERIC) AS "Indigenous",
CAST(c.indigenous AS NUMERIC) AS "Indigenous_n",
(CASE WHEN c.indigenous >= 0.2201 THEN 1 ELSE 0 END) AS "Indigenous_t",

CAST(b.vis_min AS NUMERIC) AS "Vis_Min",
CAST(c.vis_min AS NUMERIC) AS "Vis_Min_n",
(CASE WHEN c.vis_min >= 0.1797 THEN 1 ELSE 0 END) AS "Vis_Min_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN lut.sovi_census_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.no_engfr,c.no_engfr,b.nosec_school,c.nosec_school,b.age_gt65,c.age_gt65,b.age_lt6, c.age_lt6,b.indigenous,c.indigenous,b.vis_min,c.vis_min,d.geom,d.geompoint;