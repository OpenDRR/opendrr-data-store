-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_thresholds_housing_conditions CASCADE;
CREATE VIEW results.social_vulnerability_thresholds_housing_conditions AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
CAST(SUM(a.number) AS NUMERIC) AS "BldNumT",
(CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) + (CASE WHEN c.bus_ha >= 0.0198 THEN 1 ELSE 0 END) + (CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) + 
(CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) AS "HousingT",

CAST(e.pop_ha AS NUMERIC) AS "Pop_ha",
CAST((CASE WHEN (CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) = 1 THEN e.pop_ha * b.censuspop ELSE 0 END) AS NUMERIC) AS "Pop_Ha_p",

CAST(e.bus_ha AS NUMERIC) AS "Bus_Ha",
CAST((CASE WHEN (CASE WHEN c.bus_ha >= 0.0198 THEN 1 ELSE 0 END) = 1 THEN e.bus_ha * b.censuspop ELSE 0 END) AS NUMERIC) AS "Bus_Ha_p",

CAST(e.pre_1975 AS NUMERIC) AS "Pre_1975",
CAST((CASE WHEN (CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) = 1 THEN e.pre_1975 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Pre_1975_p",

CAST(e.hshld_nsuit AS NUMERIC) AS "Hshld_Nsuit",
CAST((CASE WHEN (CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) = 1 THEN e.hshld_nsuit * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_Nsuit_p",

CAST(e.hshld_mntnage AS NUMERIC) AS "Hshld_MntnAge",
CAST((CASE WHEN (CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) = 1 THEN e.hshld_mntnage * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_MntnAge_p",

CAST(e.hshld_mntn1 AS NUMERIC) AS "Hshld_Mntn1",
CAST((CASE WHEN (CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) = 1 THEN e.hshld_mntn1 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_Mntn1_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d ON a.sauid = d."SAUIDt"
LEFT JOIN lut.sovi_census_canada e ON a.sauid = e.sauidt
GROUP BY a.sauid,b.censuspop,e.pop_ha,c.pop_ha,e.bus_ha,c.bus_ha,e.pre_1975,c.pre_1975,e.hshld_nsuit,c.hshld_nsuit,e.hshld_mntnage,c.hshld_mntnage,e.hshld_mntn1,c.hshld_mntn1,d.geom,d.geompoint;