-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_family_structure_view CASCADE;
CREATE VIEW results.social_vulnerability_family_structure_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
(CASE WHEN c.renter >= 0.1731 THEN 1 ELSE 0 END) + (CASE WHEN c.live_alone >= 0.3674 THEN 1 ELSE 0 END) + (CASE WHEN c.lonepar3kids >= 0.3099 THEN 1 ELSE 0 END) + 
(CASE WHEN c.fam_gt5 >= 0.2184 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) 
+ (CASE WHEN c.imm_lt5 >= 0.1421 THEN 1 ELSE 0 END) AS "FamilyT",

CAST(b.renter AS NUMERIC) AS "Renter",
CAST((CASE WHEN (CASE WHEN c.renter >= 0.1731 THEN 1 ELSE 0 END) = 1 THEN b.renter * b.censuspop ELSE 0 END) AS NUMERIC) AS "Renter_p",

CAST(b.live_alone AS NUMERIC) AS "Live_Alone",
CAST((CASE WHEN (CASE WHEN c.live_alone >= 0.3674 THEN 1 ELSE 0 END) = 1 THEN b.live_alone * b.censuspop ELSE 0 END) AS NUMERIC) AS "Live_Alone_p",

CAST(b.lonepar3kids AS NUMERIC) AS "LonePar3Kids",
CAST((CASE WHEN (CASE WHEN c.lonepar3kids >= 0.3099 THEN 1 ELSE 0 END) = 1 THEN b.lonepar3kids * b.censuspop ELSE 0 END) AS NUMERIC) AS "LonePar3Kids_p",

CAST(b.fam_gt5 AS NUMERIC) AS "Fam_GT5",
CAST((CASE WHEN (CASE WHEN c.fam_gt5 >= 0.2184 THEN 1 ELSE 0 END) = 1 THEN b.fam_gt5 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Fam_GT5_p",

CAST(b.moved_lt1 AS NUMERIC) AS "Moved_LT1",
CAST((CASE WHEN (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) = 1 THEN b.moved_lt1 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Moved_LT1_p",

CAST(b.imm_lt5 AS NUMERIC) AS "Imm_LT5",
CAST((CASE WHEN (CASE WHEN c.imm_lt5 >= 0.1421 THEN 1 ELSE 0 END) = 1 THEN b.imm_lt5 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Imm_LT5_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.renter,c.renter,b.live_alone,c.live_alone,b.lonepar3kids,c.lonepar3kids,b.fam_gt5,c.fam_gt5,b.moved_lt1,c.moved_lt1,b.imm_lt5,c.imm_lt5,d.geom,d.geompoint;