-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_family_structure CASCADE;
CREATE VIEW results.social_vulnerability_family_structure AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
a.sauid AS "Sauid",
CAST(b.renter AS NUMERIC) AS "Renter",
CAST(c.renter AS NUMERIC) AS "Renter_n",
(CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) AS "Renter_t",

CAST(b.live_alone AS NUMERIC) AS "Live_Alone",
CAST(c.live_alone AS NUMERIC) AS "Live_Alone_n",
(CASE WHEN c.live_alone >= 0.3059 THEN 1 ELSE 0 END) AS "Live_Alone_t",

CAST(b.lonepar3kids AS NUMERIC) AS "LonePar3Kids",
CAST(c.lonepar3kids AS NUMERIC) AS "LonePar3Kids_n",
(CASE WHEN c.lonepar3kids >= 0.2964 THEN 1 ELSE 0 END) AS "LonePar3Kids_t",

CAST(b.fam_gt5 AS NUMERIC) AS "Fam_GT5",
CAST(c.fam_gt5 AS NUMERIC) AS "Fam_GT5_n",
(CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) AS "Fam_GT5_t",

CAST(b.moved_lt1 AS NUMERIC) AS "Moved_LT1",
CAST(c.moved_lt1 AS NUMERIC) AS "Moved_LT1_n",
(CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) AS "Moved_LT1_t",

CAST(b.imm_lt5 AS NUMERIC) AS "Imm_LT5",
CAST(c.imm_lt5 AS NUMERIC) AS "Imm_LT5_n",
(CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) AS "Imm_LT5_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.sovi_census_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d ON a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.renter,c.renter,b.live_alone,c.live_alone,b.lonepar3kids,c.lonepar3kids,b.fam_gt5,c.fam_gt5,b.moved_lt1,c.moved_lt1,b.imm_lt5,c.imm_lt5,d.geom,d.geompoint;