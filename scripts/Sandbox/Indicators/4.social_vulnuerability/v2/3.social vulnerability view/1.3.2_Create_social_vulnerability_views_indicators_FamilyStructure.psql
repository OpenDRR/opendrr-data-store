-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_family_structure_view CASCADE;
CREATE VIEW results.social_vulnerability_family_structure_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
(CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) + (CASE WHEN c.live_alone >=0.3059 THEN 1 ELSE 0 END) + (CASE WHEN c.lonepar3kids >=0.2964 THEN 1 ELSE 0 END) + 
(CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) AS "FamilyT",

CAST(e.renter AS NUMERIC) AS "Renter",
CAST((CASE WHEN (CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) = 1 THEN e.renter * b.censuspop ELSE 0 END) AS NUMERIC) AS "Renter_p",

CAST(e.live_alone AS NUMERIC) AS "Live_Alone",
CAST((CASE WHEN (CASE WHEN c.live_alone >=0.3059 THEN 1 ELSE 0 END) = 1 THEN e.live_alone * b.censuspop ELSE 0 END) AS NUMERIC) AS "Live_Alone_p",

CAST(e.lonepar3kids AS NUMERIC) AS "LonePar3Kids",
CAST((CASE WHEN (CASE WHEN c.lonepar3kids >=0.2964 THEN 1 ELSE 0 END) = 1 THEN e.lonepar3kids * b.censuspop ELSE 0 END) AS NUMERIC) AS "LonePar3Kids_p",

CAST(e.fam_gt5 AS NUMERIC) AS "Fam_GT5",
CAST((CASE WHEN (CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) = 1 THEN e.fam_gt5 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Fam_GT5_p",

CAST(e.moved_lt1 AS NUMERIC) AS "Moved_LT1",
CAST((CASE WHEN (CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) = 1 THEN e.moved_lt1 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Moved_LT1_p",

CAST(e.imm_lt5 AS NUMERIC) AS "Imm_LT5",
CAST((CASE WHEN (CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) = 1 THEN e.imm_lt5 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Imm_LT5_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d ON a.sauid = d."SAUIDt"
LEFT JOIN lut.sovi_census_canada e ON a.sauid = e.sauidt
GROUP BY a.sauid,b.censuspop,e.renter,c.renter,e.live_alone,c.live_alone,e.lonepar3kids,c.lonepar3kids,e.fam_gt5,c.fam_gt5,e.moved_lt1,c.moved_lt1,e.imm_lt5,c.imm_lt5,d.geom,d.geompoint;