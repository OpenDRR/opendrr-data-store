-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_thresholds_financial_agency CASCADE;
CREATE VIEW results.social_vulnerability_thresholds_financial_agency AS 

-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_thresholds_financial_agency CASCADE;
CREATE VIEW results.social_vulnerability_thresholds_financial_agency AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
(CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= 0.4436 THEN 1 ELSE 0 END) + 
(CASE WHEN c.work_parttime >=0.596 THEN 1 ELSE 0 END) + (CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) AS "AgencyT",

CAST(e.shltr_gt30 AS NUMERIC) AS "Shltr_GT30",
CAST((CASE WHEN (CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) = 1 THEN e.shltr_gt30 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Shltr_GT30_p",

CAST(e.inc_lowdecile AS NUMERIC) AS "Inc_LowDecile",
CAST((CASE WHEN (CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) = 1 THEN e.inc_lowdecile * b.censuspop ELSE 0 END) AS NUMERIC) AS "Inc_LowDecile_p",

CAST(e.unemployed AS NUMERIC) AS "Unemployed",
CAST((CASE WHEN (CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) = 1 THEN e.unemployed * b.censuspop ELSE 0 END) AS NUMERIC) AS "Unemployed_p",

CAST(e.work_none AS NUMERIC) AS "Work_None",
CAST((CASE WHEN (CASE WHEN c.work_none >= 0.4436 THEN 1 ELSE 0 END) = 1 THEN e.work_none * b.censuspop ELSE 0 END) AS NUMERIC) AS "Work_None_p",

CAST(e.work_parttime AS NUMERIC) AS "Work_Parttime",
CAST((CASE WHEN (CASE WHEN c.work_parttime >= 0.596 THEN 1 ELSE 0 END) = 1 THEN e.work_parttime * b.censuspop ELSE 0 END) AS NUMERIC) AS "Work_Parttime_p",

CAST(e.employ_inc AS NUMERIC) AS "Employ_Inc",
CAST((CASE WHEN (CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) = 1 THEN e.employ_inc * b.censuspop ELSE 0 END) AS NUMERIC) AS "Employ_Inc_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d ON a.sauid = d."SAUIDt"
LEFT JOIN lut.sovi_census_canada e ON a.sauid = e.sauidt
GROUP BY a.sauid,b.censuspop,e.shltr_gt30,c.shltr_gt30,e.inc_lowdecile,c.inc_lowdecile,e.unemployed,c.unemployed,e.work_none,c.work_none,e.work_parttime,c.work_parttime,e.employ_inc,c.employ_inc,d.geom,d.geompoint;