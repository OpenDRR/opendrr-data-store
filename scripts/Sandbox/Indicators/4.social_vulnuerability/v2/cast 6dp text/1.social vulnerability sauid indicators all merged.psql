-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_housing_conditions CASCADE;
CREATE VIEW results_text.social_vulnerability_housing_conditions AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.censuspop AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "CensusPop",
CAST(CAST(CAST(ROUND(CAST(SUM(a.number) AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "BldNumT",

CAST(CAST(CAST(ROUND(CAST(e.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pop_ha",
CAST(CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pop_ha_n",
(CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) AS "Pop_ha_t",

CAST(CAST(CAST(ROUND(CAST(e.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Bus_Ha",
CAST(CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Bus_Ha_n",
(CASE WHEN c.bus_ha >= 0.0198 THEN 1 ELSE 0 END) AS "Bus_Ha_t",

CAST(CAST(CAST(ROUND(CAST(e.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pre_1975",
CAST(CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Pre_1975_n",
(CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) AS "Pre_1975_t",

CAST(CAST(CAST(ROUND(CAST(e.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Nsuit",
CAST(CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Nsuit_n",
(CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) AS "Hshld_Nsuit_t",

CAST(CAST(CAST(ROUND(CAST(e.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_MntnAge",
CAST(CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_MntnAge_n",
(CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) AS "Hshld_MntnAge_t",

CAST(CAST(CAST(ROUND(CAST(e.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Mntn1",
CAST(CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Hshld_Mntn1_n",
(CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) AS "Hshld_Mntn1_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
LEFT JOIN lut.sovi_census_canada e ON a.sauid = e.sauidt
GROUP BY a.sauid,b.censuspop,e.pop_ha,c.pop_ha,e.bus_ha,c.bus_ha,e.pre_1975,c.pre_1975,e.hshld_nsuit,c.hshld_nsuit,e.hshld_mntnage,c.hshld_mntnage,
e.hshld_mntn1,c.hshld_mntn1,d.geom,d.geompoint;

-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_family_structure CASCADE;
CREATE VIEW results_text.social_vulnerability_family_structure AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Renter",
CAST(CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Renter_n",
(CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) AS "Renter_t",

CAST(CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Live_Alone",
CAST(CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Live_Alone_n",
(CASE WHEN c.live_alone >= 0.3059 THEN 1 ELSE 0 END) AS "Live_Alone_t",

CAST(CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "LonePar3Kids",
CAST(CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "LonePar3Kids_n",
(CASE WHEN c.lonepar3kids >= 0.2964 THEN 1 ELSE 0 END) AS "LonePar3Kids_t",

CAST(CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Fam_GT5",
CAST(CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Fam_GT5_n",
(CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) AS "Fam_GT5_t",

CAST(CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Moved_LT1",
CAST(CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Moved_LT1_n",
(CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) AS "Moved_LT1_t",

CAST(CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Imm_LT5",
CAST(CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Imm_LT5_n",
(CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) AS "Imm_LT5_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN lut.sovi_census_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d ON a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.renter,c.renter,b.live_alone,c.live_alone,b.lonepar3kids,c.lonepar3kids,b.fam_gt5,c.fam_gt5,b.moved_lt1,c.moved_lt1,b.imm_lt5,c.imm_lt5,d.geom,d.geompoint;

-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_individual_autonomy CASCADE;
CREATE VIEW results_text.social_vulnerability_individual_autonomy AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual autonomony
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "No_EngFr",
CAST(CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "No_EngFr_n",
(CASE WHEN c.no_engfr >= 0.0859 THEN 1 ELSE 0 END) AS "NoEngfr_t",

CAST(CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "NoSec_School",
CAST(CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "NoSec_School_n",
(CASE WHEN c.nosec_school >= 0.2782 THEN 1 ELSE 0 END) AS "NoSec_School_t",

CAST(CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_GT65",
CAST(CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_GT65_n",
(CASE WHEN c.age_gt65 >= 0.3333 THEN 1 ELSE 0 END) AS "Age_GT65_t",

CAST(CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_LT6",
CAST(CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Age_LT6_n",
(CASE WHEN c.age_lt6 >= 0.4388 THEN 1 ELSE 0 END) AS "Age_LT65_t",

CAST(CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Indigenous",
CAST(CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Indigenous_n",
(CASE WHEN c.indigenous >= 0.2201 THEN 1 ELSE 0 END) AS "Indigenous_t",

CAST(CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Vis_Min",
CAST(CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Vis_Min_n",
(CASE WHEN c.vis_min >= 0.1797 THEN 1 ELSE 0 END) AS "Vis_Min_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN lut.sovi_census_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.no_engfr,c.no_engfr,b.nosec_school,c.nosec_school,b.age_gt65,c.age_gt65,b.age_lt6, c.age_lt6,b.indigenous,c.indigenous,b.vis_min,c.vis_min,d.geom,d.geompoint;

-- create social vulnerability indicators
DROP VIEW IF EXISTS results_text.social_vulnerability_financial_agency CASCADE;
CREATE VIEW results_text.social_vulnerability_financial_agency AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Financial Agency
SELECT 
a.sauid AS "Sauid",
CAST(CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Shltr_GT30",
CAST(CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Shltr_GT30_n",
(CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) AS "Shltr_GT30_t",

CAST(CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Inc_LowDecile",
CAST(CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Inc_LowDecile_n",
(CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) AS "Inc_LowDecile_t",

CAST(CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Unemployed",
CAST(CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Unemployed_n",
(CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) AS "Unemployed_t",

CAST(CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_None",
CAST(CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_None_n",
(CASE WHEN c.work_none >= 0.4436 THEN 1 ELSE 0 END) AS "Work_None_t",

CAST(CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_Parttime",
CAST(CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Work_Parttime_n",
(CASE WHEN c.work_parttime >= 0.596 THEN 1 ELSE 0 END) AS "Work_Parttime_t",

CAST(CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Employ_Inc",
CAST(CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS TEXT) AS "Employ_Inc_n",
(CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) AS "Employ_Inc_t",
d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN lut.sovi_census_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.shltr_gt30,c.shltr_gt30,b.inc_lowdecile,c.inc_lowdecile,b.unemployed,c.unemployed,b.work_none,c.work_none,b.work_parttime,c.work_parttime,b.employ_inc,c.employ_inc,d.geom,d.geompoint;