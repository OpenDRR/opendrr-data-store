-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_housing_conditions_view CASCADE;
CREATE VIEW results_float.social_vulnerability_housing_conditions_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
b.censuspop AS "CensusPop",
SUM(a.number) AS "BldNumT",
(CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) + (CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) + (CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) + 
(CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) AS "HousingT",

b.pop_ha AS "Pop_ha",
(CASE WHEN (CASE WHEN c.pop_ha >= 0.095 THEN 1 ELSE 0 END) = 1 THEN b.pop_ha * b.censuspop ELSE 0 END) AS "Pop_Ha_p",

b.bus_ha AS "Bus_Ha",
(CASE WHEN (CASE WHEN c.bus_ha >= 0.0491 THEN 1 ELSE 0 END) = 1 THEN b.bus_ha * b.censuspop ELSE 0 END) AS "Bus_Ha_p",

b.pre_1975 AS "Pre_1975",
(CASE WHEN (CASE WHEN c.pre_1975 >= 0.7699 THEN 1 ELSE 0 END) = 1 THEN b.pre_1975 * b.censuspop ELSE 0 END) AS "Pre_1975_p",

b.hshld_nsuit AS "Hshld_Nsuit",
(CASE WHEN (CASE WHEN c.hshld_nsuit >= 0.5523 THEN 1 ELSE 0 END) = 1 THEN b.hshld_nsuit * b.censuspop ELSE 0 END) AS "Hshld_Nsuit_p",

b.hshld_mntnage AS "Hshld_MntnAge",
(CASE WHEN (CASE WHEN c.hshld_mntnage >= 0.4267 THEN 1 ELSE 0 END) = 1 THEN b.hshld_mntnage * b.censuspop ELSE 0 END) AS "Hshld_MntnAge_p",

b.hshld_mntn1 AS "Hshld_Mntn1",
(CASE WHEN (CASE WHEN c.hshld_mntn1 >= 0.7165 THEN 1 ELSE 0 END) = 1 THEN b.hshld_mntn1 * b.censuspop ELSE 0 END) AS "Hshld_Mntn1_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.pop_ha,c.pop_ha,b.bus_ha,c.bus_ha,b.pre_1975,c.pre_1975,b.hshld_nsuit,c.hshld_nsuit,b.hshld_mntnage,c.hshld_mntnage,b.hshld_mntn1,c.hshld_mntn1,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_family_structure_view CASCADE;
CREATE VIEW results_float.social_vulnerability_family_structure_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
a.sauid AS "Sauid",
b.censuspop AS "CensusPop",
(CASE WHEN c.renter >= 0.1731 THEN 1 ELSE 0 END) + (CASE WHEN c.live_alone >= 0.3674 THEN 1 ELSE 0 END) + (CASE WHEN c.lonepar3kids >= 0.3099 THEN 1 ELSE 0 END) + 
(CASE WHEN c.fam_gt5 >= 0.2184 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) 
+ (CASE WHEN c.imm_lt5 >= 0.1421 THEN 1 ELSE 0 END) AS "FamilyT",

b.renter AS "Renter",
(CASE WHEN (CASE WHEN c.renter >= 0.1731 THEN 1 ELSE 0 END) = 1 THEN b.renter * b.censuspop ELSE 0 END) AS "Renter_p",

b.live_alone AS "Live_Alone",
(CASE WHEN (CASE WHEN c.live_alone >= 0.3674 THEN 1 ELSE 0 END) = 1 THEN b.live_alone * b.censuspop ELSE 0 END) AS "Live_Alone_p",

b.lonepar3kids AS "LonePar3Kids",
(CASE WHEN (CASE WHEN c.lonepar3kids >= 0.3099 THEN 1 ELSE 0 END) = 1 THEN b.lonepar3kids * b.censuspop ELSE 0 END) AS "LonePar3Kids_p",

b.fam_gt5 AS "Fam_GT5",
(CASE WHEN (CASE WHEN c.fam_gt5 >= 0.2184 THEN 1 ELSE 0 END) = 1 THEN b.fam_gt5 * b.censuspop ELSE 0 END) AS "Fam_GT5_p",

b.moved_lt1 AS "Moved_LT1",
(CASE WHEN (CASE WHEN c.moved_lt1 >= 0.2695 THEN 1 ELSE 0 END) = 1 THEN b.moved_lt1 * b.censuspop ELSE 0 END) AS "Moved_LT1_p",

b.imm_lt5 AS "Imm_LT5",
(CASE WHEN (CASE WHEN c.imm_lt5 >= 0.1421 THEN 1 ELSE 0 END) = 1 THEN b.imm_lt5 * b.censuspop ELSE 0 END) AS "Imm_LT5_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.renter,c.renter,b.live_alone,c.live_alone,b.lonepar3kids,c.lonepar3kids,b.fam_gt5,c.fam_gt5,b.moved_lt1,c.moved_lt1,b.imm_lt5,c.imm_lt5,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_individual_autonomy_view CASCADE;
CREATE VIEW results_float.social_vulnerability_individual_autonomy_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual autonomony
SELECT 
a.sauid AS "Sauid",
b.censuspop AS "CensusPop",
(CASE WHEN c.no_engfr >= 0.808 THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= 0.2405 THEN 1 ELSE 0 END) + (CASE WHEN c.age_gt65 >= 0.3136 THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= 0.378 THEN 1 ELSE 0 END) +
(CASE WHEN c.indigenous >= 0.2029 THEN 1 ELSE 0 END) + (CASE WHEN c.vis_min >= 0.4148 THEN 1 ELSE 0 END) AS "AutonomyT",

b.no_engfr AS "No_EngFr",
(CASE WHEN (CASE WHEN c.no_engfr >= 0.808 THEN 1 ELSE 0 END) = 1 THEN b.no_engfr * b.censuspop ELSE 0 END) AS "No_EngFr_p",

b.nosec_school AS "NoSec_School",
(CASE WHEN (CASE WHEN c.nosec_school >= 0.2405 THEN 1 ELSE 0 END) = 1 THEN b.nosec_school * b.censuspop ELSE 0 END) AS "NoSec_School_p",

b.age_gt65 AS "Age_GT65",
(CASE WHEN (CASE WHEN c.age_gt65 >= 0.3136 THEN 1 ELSE 0 END) = 1 THEN b.age_gt65 * b.censuspop ELSE 0 END) AS "Age_GT65_p",

b.age_lt6 AS "Age_LT6",
(CASE WHEN (CASE WHEN c.age_lt6 >= 0.378 THEN 1 ELSE 0 END) = 1 THEN b.age_lt6 * b.censuspop ELSE 0 END) AS "Age_LT6_p",

b.indigenous AS "Indigenous",
(CASE WHEN (CASE WHEN c.indigenous >= 0.2029 THEN 1 ELSE 0 END) = 1 THEN b.indigenous * b.censuspop ELSE 0 END) AS "Indigenous_p",

b.vis_min AS "Vis_Min",
(CASE WHEN (CASE WHEN c.vis_min >= 0.4148 THEN 1 ELSE 0 END) = 1 THEN b.vis_min * b.censuspop ELSE 0 END) AS "Vis_Min_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.no_engfr,c.no_engfr,b.nosec_school,c.nosec_school,b.age_gt65,c.age_gt65,b.age_lt6, c.age_lt6,b.indigenous,c.indigenous,b.vis_min,c.vis_min,d.geom,d.geompoint;


-- create social vulnerability indicators
DROP VIEW IF EXISTS results_float.social_vulnerability_financial_agency_view CASCADE;
CREATE VIEW results_float.social_vulnerability_financial_agency_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
SELECT 
a.sauid AS "Sauid",
b.censuspop AS "CensusPop",
(CASE WHEN c.shltr_gt30 >= 0.4084 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_lowdecile >= 0.6936 THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= 0.2887 THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= 0.464 THEN 1 ELSE 0 END) + 
(CASE WHEN c.work_parttime >= 0.5845 THEN 1 ELSE 0 END) + (CASE WHEN c.employ_inc >= 0.4275 THEN 1 ELSE 0 END) AS "AgencyT",

b.shltr_gt30 AS "Shltr_GT30",
(CASE WHEN (CASE WHEN c.shltr_gt30 >= 0.4084 THEN 1 ELSE 0 END) = 1 THEN b.shltr_gt30 * b.censuspop ELSE 0 END) AS "Shltr_GT30_p",

b.inc_lowdecile AS "Inc_LowDecile",
(CASE WHEN (CASE WHEN c.inc_lowdecile >= 0.6936 THEN 1 ELSE 0 END) = 1 THEN b.inc_lowdecile * b.censuspop ELSE 0 END) AS "Inc_LowDecile_p",

b.unemployed AS "Unemployed",
(CASE WHEN (CASE WHEN c.unemployed >= 0.2887 THEN 1 ELSE 0 END) = 1 THEN b.unemployed * b.censuspop ELSE 0 END) AS "Unemployed_p",

b.work_none AS "Work_None",
(CASE WHEN (CASE WHEN c.work_none >= 0.464 THEN 1 ELSE 0 END) = 1 THEN b.work_none * b.censuspop ELSE 0 END) AS "Work_None_p",

b.work_parttime AS "Work_Parttime",
(CASE WHEN (CASE WHEN b.work_parttime >= 0.464 THEN 1 ELSE 0 END) = 1 THEN b.work_parttime * b.censuspop ELSE 0 END) AS "Work_Parttime_p",

b.employ_inc AS "Employ_Inc",
(CASE WHEN (CASE WHEN c.employ_inc >= 0.4275 THEN 1 ELSE 0 END) = 1 THEN b.employ_inc * b.censuspop ELSE 0 END) AS "Employ_Inc_p",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM psra.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
GROUP BY a.sauid,b.censuspop,b.shltr_gt30,c.shltr_gt30,b.inc_lowdecile,c.inc_lowdecile,b.unemployed,c.unemployed,b.work_none,c.work_none,b.work_parttime,c.work_parttime,b.employ_inc,c.employ_inc,d.geom,d.geompoint;