-- create social vulnerability indicators
DROP VIEW IF EXISTS results.social_vulnerability_social_fabric_sauid_view CASCADE;
CREATE VIEW results.social_vulnerability_social_fabric_sauid_view AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
CAST(b.censuspop AS NUMERIC) AS "CensusPop",
CAST(SUM(a.number) AS NUMERIC) AS "BldNumT",
(CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) + (CASE WHEN c.bus_ha >= 0.0198 THEN 1 ELSE 0 END) + (CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) + 
(CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) AS "HousingT",

CAST(e.pop_ha AS NUMERIC) AS "Pop_ha",
CAST((CASE WHEN (CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) = 1 THEN e.pop_ha * b.censuspop ELSE 0 END) AS NUMERIC) AS "Pop_Ha_p",

CAST(e.bus_ha AS NUMERIC) AS "Bus_Ha",
CAST((CASE WHEN (CASE WHEN c.bus_ha >= 0.0198 THEN 1 ELSE 0 END) = 1 THEN e.bus_ha * b.censuspop ELSE 0 END) AS NUMERIC) AS "Bus_Ha_p",

CAST(e.pre_1975 AS NUMERIC) AS "Pre_1975",
CAST((CASE WHEN (CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) = 1 THEN e.pre_1975 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Pre_1975_p",

CAST(e.hshld_nsuit AS NUMERIC) AS "Hshld_Nsuit",
CAST((CASE WHEN (CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) = 1 THEN e.hshld_nsuit * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_Nsuit_p",

CAST(e.hshld_mntnage AS NUMERIC) AS "Hshld_MntnAge",
CAST((CASE WHEN (CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) = 1 THEN e.hshld_mntnage * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_MntnAge_p",

CAST(e.hshld_mntn1 AS NUMERIC) AS "Hshld_Mntn1",
CAST((CASE WHEN (CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) = 1 THEN e.hshld_mntn1 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Hshld_Mntn1_p",

-- 1.3.2 Family Structure
(CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) + (CASE WHEN c.live_alone >=0.3059 THEN 1 ELSE 0 END) + (CASE WHEN c.lonepar3kids >=0.2964 THEN 1 ELSE 0 END) + 
(CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) + (CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) AS "FamilyT",

CAST(e.renter AS NUMERIC) AS "Renter",
CAST((CASE WHEN (CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) = 1 THEN e.renter * b.censuspop ELSE 0 END) AS NUMERIC) AS "Renter_p",

CAST(e.live_alone AS NUMERIC) AS "Live_Alone",
CAST((CASE WHEN (CASE WHEN c.live_alone >=0.3059 THEN 1 ELSE 0 END) = 1 THEN e.live_alone * b.censuspop ELSE 0 END) AS NUMERIC) AS "Live_Alone_p",

CAST(e.lonepar3kids AS NUMERIC) AS "LonePar3Kids",
CAST((CASE WHEN (CASE WHEN c.lonepar3kids >=0.2964 THEN 1 ELSE 0 END) = 1 THEN e.lonepar3kids * b.censuspop ELSE 0 END) AS NUMERIC) AS "LonePar3Kids_p",

CAST(e.fam_gt5 AS NUMERIC) AS "Fam_GT5",
CAST((CASE WHEN (CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) = 1 THEN e.fam_gt5 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Fam_GT5_p",

CAST(e.moved_lt1 AS NUMERIC) AS "Moved_LT1",
CAST((CASE WHEN (CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) = 1 THEN e.moved_lt1 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Moved_LT1_p",

CAST(e.imm_lt5 AS NUMERIC) AS "Imm_LT5",
CAST((CASE WHEN (CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) = 1 THEN e.imm_lt5 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Imm_LT5_p",

-- 1.3.3 Individual autonomony
(CASE WHEN c.no_engfr >= 0.0859 THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= 0.2782 THEN 1 ELSE 0 END) + (CASE WHEN c.age_gt65 >= 0.3333 THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >=0.4388 THEN 1 ELSE 0 END) +
(CASE WHEN c.indigenous >= 0.2201 THEN 1 ELSE 0 END) + (CASE WHEN c.vis_min >= 0.1797 THEN 1 ELSE 0 END) AS "AutonomyT",

CAST(e.no_engfr AS NUMERIC) AS "No_EngFr",
CAST((CASE WHEN (CASE WHEN c.no_engfr >= 0.0859 THEN 1 ELSE 0 END) = 1 THEN e.no_engfr * b.censuspop ELSE 0 END) AS NUMERIC) AS "No_EngFr_p",

CAST(e.nosec_school AS NUMERIC) AS "NoSec_School",
CAST((CASE WHEN (CASE WHEN c.nosec_school >= 0.2782 THEN 1 ELSE 0 END) = 1 THEN e.nosec_school * b.censuspop ELSE 0 END) AS NUMERIC) AS "NoSec_School_p",

CAST(e.age_gt65 AS NUMERIC) AS "Age_GT65",
CAST((CASE WHEN (CASE WHEN c.age_gt65 >= 0.3333 THEN 1 ELSE 0 END) = 1 THEN e.age_gt65 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Age_GT65_p",

CAST(e.age_lt6 AS NUMERIC) AS "Age_LT6",
CAST((CASE WHEN (CASE WHEN c.age_lt6 >=0.4388 THEN 1 ELSE 0 END) = 1 THEN e.age_lt6 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Age_LT6_p",

CAST(e.indigenous AS NUMERIC) AS "Indigenous",
CAST((CASE WHEN (CASE WHEN c.indigenous >= 0.2201 THEN 1 ELSE 0 END) = 1 THEN e.indigenous * b.censuspop ELSE 0 END) AS NUMERIC) AS "Indigenous_p",

CAST(e.vis_min AS NUMERIC) AS "Vis_Min",
CAST((CASE WHEN (CASE WHEN c.vis_min >= 0.1797 THEN 1 ELSE 0 END) = 1 THEN e.vis_min * b.censuspop ELSE 0 END) AS NUMERIC) AS "Vis_Min_p",

-- 1.3.4 Financial Agency
(CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= 0.4436 THEN 1 ELSE 0 END) + 
(CASE WHEN c.work_parttime >=0.596 THEN 1 ELSE 0 END) + (CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) AS "AgencyT",

CAST(e.shltr_gt30 AS NUMERIC) AS "Shltr_GT30",
CAST((CASE WHEN (CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) = 1 THEN e.shltr_gt30 * b.censuspop ELSE 0 END) AS NUMERIC) AS "Shltr_GT30_p",

CAST(e.inc_lowdecile AS NUMERIC) AS "Inc_LowDecile",
CAST((CASE WHEN (CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) = 1 THEN e.inc_lowdecile * b.censuspop ELSE 0 END) AS NUMERIC) AS "Inc_LowDecile_p",

CAST(e.unemployed AS NUMERIC) AS "Unemployed",
CAST((CASE WHEN (CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) = 1 THEN e.unemployed * b.censuspop ELSE 0 END) AS NUMERIC) AS "Unemployed_p",

CAST(e.work_none AS NUMERIC) AS "Work_None",
CAST((CASE WHEN (CASE WHEN c.work_none >= 0.4436 THEN 1 ELSE 0 END) = 1 THEN e.work_none * b.censuspop ELSE 0 END) AS NUMERIC) AS "Work_None_p",

CAST(e.work_parttime AS NUMERIC) AS "Work_Parttime",
CAST((CASE WHEN (CASE WHEN c.work_parttime >= 0.596 THEN 1 ELSE 0 END) = 1 THEN e.work_parttime * b.censuspop ELSE 0 END) AS NUMERIC) AS "Work_Parttime_p",

CAST(e.employ_inc AS NUMERIC) AS "Employ_Inc",
CAST((CASE WHEN (CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) = 1 THEN e.employ_inc * b.censuspop ELSE 0 END) AS NUMERIC) AS "Employ_Inc_p",

CAST(e.inc_indv AS NUMERIC) AS "Inc_Indv",
CAST(e.inc_hshld AS NUMERIC) AS "Inc_Hshld",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN lut.census_2016_canada b ON a.sauid = b.sauidt
LEFT JOIN lut.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d ON a.sauid = d."SAUIDt"
LEFT JOIN lut.sovi_census_canada e ON a.sauid = e.sauidt
GROUP BY a.sauid,b.censuspop,e.pop_ha,c.pop_ha,e.bus_ha,c.bus_ha,e.pre_1975,c.pre_1975,e.hshld_nsuit,c.hshld_nsuit,e.hshld_mntnage,c.hshld_mntnage,e.hshld_mntn1,c.hshld_mntn1,e.renter,c.renter,
e.live_alone,c.live_alone,e.lonepar3kids,c.lonepar3kids,e.fam_gt5,c.fam_gt5,e.moved_lt1,c.moved_lt1,e.imm_lt5,c.imm_lt5,e.no_engfr,c.no_engfr,e.nosec_school,c.nosec_school,e.age_gt65,c.age_gt65,e.age_lt6,
c.age_lt6,e.indigenous,c.indigenous,e.vis_min,c.vis_min,e.shltr_gt30,c.shltr_gt30,e.inc_lowdecile,c.inc_lowdecile,e.unemployed,c.unemployed,e.work_none,c.work_none,e.work_parttime,c.work_parttime,e.employ_inc,c.employ_inc,
e.inc_indv,e.inc_hshld,d.geom,d.geompoint;