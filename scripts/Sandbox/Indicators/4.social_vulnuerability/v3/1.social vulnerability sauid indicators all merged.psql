-- create schema for new scenario
CREATE SCHEMA IF NOT EXISTS results_sovi;

-- create social vulnerability indicators
DROP VIEW IF EXISTS results_sovi.social_vulnerability_social_fabric_sauid CASCADE;
CREATE VIEW results_sovi.social_vulnerability_social_fabric_sauid AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
a.sauid AS "Sauid",
CAST(e.censuspop AS NUMERIC) AS "CensusPop",
CAST(SUM(a.number) AS NUMERIC) AS "BldNumT",

CAST(b.pop_ha AS NUMERIC) AS "Pop_ha",
CAST(c.pop_ha AS NUMERIC) AS "Pop_ha_n",
(CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) AS "Pop_ha_t",

CAST(b.bus_ha AS NUMERIC) AS "Bus_Ha",
CAST(c.bus_ha AS NUMERIC) AS "Bus_Ha_n",
(CASE WHEN c.bus_ha >= 0.0198 THEN 1 ELSE 0 END) AS "Bus_Ha_t",

CAST(b.pre_1975 AS NUMERIC) AS "Pre_1975",
CAST(c.pre_1975 AS NUMERIC) AS "Pre_1975_n",
(CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) AS "Pre_1975_t",

CAST(b.hshld_nsuit AS NUMERIC) AS "Hshld_Nsuit",
CAST(c.hshld_nsuit AS NUMERIC) AS "Hshld_Nsuit_n",
(CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) AS "Hshld_Nsuit_t",

CAST(b.hshld_mntnage AS NUMERIC) AS "Hshld_MntnAge",
CAST(c.hshld_mntnage AS NUMERIC) AS "Hshld_MntnAge_n",
(CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) AS "Hshld_MntnAge_t",

CAST(b.hshld_mntn1 AS NUMERIC) AS "Hshld_Mntn1",
CAST(c.hshld_mntn1 AS NUMERIC) AS "Hshld_Mntn1_n",
(CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) AS "Hshld_Mntn1_t",

-- 1.3.2 Family Structure
CAST(b.renter AS NUMERIC) AS "Renter",
CAST(c.renter AS NUMERIC) AS "Renter_n",
(CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) AS "Renter_t",

CAST(b.live_alone AS NUMERIC) AS "Live_Alone",
CAST(c.live_alone AS NUMERIC) AS "Live_Alone_n",
(CASE WHEN c.live_alone >= 0.3059 THEN 1 ELSE 0 END) AS "Live_Alone_t",

CAST(b.lonepar3kids AS NUMERIC) AS "LonePar3Kids",
CAST(c.lonepar3kids AS NUMERIC) AS "LonePar3Kids_n",
(CASE WHEN c.lonepar3kids >= 0.2964 THEN 1 ELSE 0 END) AS "LonePar3Kids_t",

CAST(b.fam_gt5 AS NUMERIC) AS "Fam_GT5",
CAST(c.fam_gt5 AS NUMERIC) AS "Fam_GT5_n",
(CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) AS "Fam_GT5_t",

CAST(b.moved_lt1 AS NUMERIC) AS "Moved_LT1",
CAST(c.moved_lt1 AS NUMERIC) AS "Moved_LT1_n",
(CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) AS "Moved_LT1_t",

CAST(b.imm_lt5 AS NUMERIC) AS "Imm_LT5",
CAST(c.imm_lt5 AS NUMERIC) AS "Imm_LT5_n",
(CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) AS "Imm_LT5_t",

-- 1.3.3 Individual autonomony
CAST(b.no_engfr AS NUMERIC) AS "No_EngFr",
CAST(c.no_engfr AS NUMERIC) AS "No_EngFr_n",
(CASE WHEN c.no_engfr >= 0.0859 THEN 1 ELSE 0 END) AS "NoEngfr_t",

CAST(b.nosec_school AS NUMERIC) AS "NoSec_School",
CAST(c.nosec_school AS NUMERIC) AS "NoSec_School_n",
(CASE WHEN c.nosec_school >= 0.2782 THEN 1 ELSE 0 END) AS "NoSec_School_t",

CAST(b.age_gt65 AS NUMERIC) AS "Age_GT65",
CAST(c.age_gt65 AS NUMERIC) AS "Age_GT65_n",
(CASE WHEN c.age_gt65 >= 0.3333 THEN 1 ELSE 0 END) AS "Age_GT65_t",

CAST(b.age_lt6 AS NUMERIC) AS "Age_LT6",
CAST(c.age_lt6 AS NUMERIC) AS "Age_LT6_n",
(CASE WHEN c.age_lt6 >= 0.4388 THEN 1 ELSE 0 END) AS "Age_LT65_t",

CAST(b.indigenous AS NUMERIC) AS "Indigenous",
CAST(c.indigenous AS NUMERIC) AS "Indigenous_n",
(CASE WHEN c.indigenous >= 0.2201 THEN 1 ELSE 0 END) AS "Indigenous_t",

CAST(b.vis_min AS NUMERIC) AS "Vis_Min",
CAST(c.vis_min AS NUMERIC) AS "Vis_Min_n",
(CASE WHEN c.vis_min >= 0.1797 THEN 1 ELSE 0 END) AS "Vis_Min_t",

-- 1.3.3 Financial Agency
CAST(b.shltr_gt30 AS NUMERIC) AS "Shltr_GT30",
CAST(c.shltr_gt30 AS NUMERIC) AS "Shltr_GT30_n",
(CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) AS "Shltr_GT30_t",

CAST(b.inc_lowdecile AS NUMERIC) AS "Inc_LowDecile",
CAST(c.inc_lowdecile AS NUMERIC) AS "Inc_LowDecile_n",
(CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) AS "Inc_LowDecile_t",

CAST(b.unemployed AS NUMERIC) AS "Unemployed",
CAST(c.unemployed AS NUMERIC) AS "Unemployed_n",
(CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) AS "Unemployed_t",

CAST(b.work_none AS NUMERIC) AS "Work_None",
CAST(c.work_none AS NUMERIC) AS "Work_None_n",
(CASE WHEN c.work_none >= 0.4436 THEN 1 ELSE 0 END) AS "Work_None_t",

CAST(b.work_parttime AS NUMERIC) AS "Work_Parttime",
CAST(c.work_parttime AS NUMERIC) AS "Work_Parttime_n",
(CASE WHEN c.work_parttime >= 0.596 THEN 1 ELSE 0 END) AS "Work_Parttime_t",

CAST(b.employ_inc AS NUMERIC) AS "Employ_Inc",
CAST(c.employ_inc AS NUMERIC) AS "Employ_Inc_n",
(CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) AS "Employ_Inc_t",

CAST(b.inc_indv AS NUMERIC) AS "Inc_Indv",
CAST(b.inc_hshld AS NUMERIC) AS "Inc_Hshld",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM exposure.canada_exposure a
LEFT JOIN sovi.sovi_census_canada b ON a.sauid = b.sauidt
LEFT JOIN sovi.sovi_index_canada c ON a.sauid = c.sauidt
LEFT JOIN boundaries."Geometry SAUID" d on a.sauid = d."SAUIDt"
LEFT JOIN census.census_2016_canada e ON a.sauid = e.sauidt
GROUP BY a.sauid,b.renter,c.renter,b.live_alone,c.live_alone,b.lonepar3kids,c.lonepar3kids,b.fam_gt5,c.fam_gt5,b.pop_ha,c.pop_ha,b.bus_ha,c.bus_ha,b.pre_1975,c.pre_1975,
b.hshld_nsuit,c.hshld_nsuit,b.hshld_mntnage,c.hshld_mntnage,b.hshld_mntn1,c.hshld_mntn1,b.moved_lt1,c.moved_lt1,b.imm_lt5,c.imm_lt5,e.censuspop,b.no_engfr,c.no_engfr,
b.nosec_school,c.nosec_school,b.age_gt65,c.age_gt65,b.age_lt6, c.age_lt6,b.indigenous,c.indigenous,b.vis_min,c.vis_min,b.shltr_gt30,c.shltr_gt30,b.inc_lowdecile,c.inc_lowdecile,
b.unemployed,c.unemployed,b.work_none,c.work_none,b.work_parttime,c.work_parttime,b.employ_inc,c.employ_inc,b.inc_indv,b.inc_hshld,d.geom,d.geompoint;