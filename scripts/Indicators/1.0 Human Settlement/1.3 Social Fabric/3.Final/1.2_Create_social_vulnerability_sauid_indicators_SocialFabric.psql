-- create schema for new scenario
CREATE SCHEMA IF NOT EXISTS results_nhsl_social_fabric;



-- create social vulnerability indicators
DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_housing_conditions_s CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_housing_conditions_s AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
SELECT 
b.sauidt AS "Sauid",
(CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) + (CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) + 
(CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) + (CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) AS "VH_Threshold",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pop_ha",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= 0.0367 THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= 0.6659 THEN 1 ELSE 0 END) AS "VHt_Pre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= 0.1496 THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= 0.4434 THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= 0.7089 THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= 0.3187 THEN 1 ELSE 0 END) AS "VHt_Renter",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt";



-- create social vulnerability indicators
DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_family_structure_s CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_family_structure_s AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
SELECT 
b.sauidt AS "Sauid",
(CASE WHEN c.live_alone >=0.3059 THEN 1 ELSE 0 END) + (CASE WHEN c.lonepar3kids >=0.2964 THEN 1 ELSE 0 END) + (CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) + (CASE  WHEN c.nowrkplace >= 0.2691 THEN 1 ELSE 0 END) AS "VF_Threshold",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LiveAlone",
(CASE WHEN c.live_alone >= 0.3059 THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= 0.2964 THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= 0.2725 THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= 0.2613 THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= 0.0856 THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= 0.2691 THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt";



-- create social vulnerability indicators
DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_individual_autonomy_s CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_individual_autonomy_s AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
SELECT 
b.sauidt AS "Sauid",
(CASE WHEN c.no_engfr >= 0.0859 THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= 0.2782 THEN 1 ELSE 0 END) + (CASE WHEN c.age_gt65 >= 0.3333 THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >=0.4388 THEN 1 ELSE 0 END) +
(CASE WHEN c.indigenous >= 0.2201 THEN 1 ELSE 0 END) + (CASE WHEN c.vis_min >= 0.1797 THEN 1 ELSE 0 END) AS "VA_Threshold",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= 0.0859 THEN 1 ELSE 0 END) AS "VAt_NoEngfr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= 0.2782 THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= 0.3333 THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= 0.4388 THEN 1 ELSE 0 END) AS "VAt_AgeLT65",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= 0.2201 THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= 0.1797 THEN 1 ELSE 0 END) AS "VAt_VisMinority",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt";



-- create social vulnerability indicators
DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_financial_agency_s CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_financial_agency_s AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
SELECT 
b.sauidt AS "Sauid",
(CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) +
 + (CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_indv >= 0.7774 THEN 1 ELSE 0 END) + (CASE WHEN c.inc_hshld >= 0.8559 THEN 1 ELSE 0 END) AS "VE_Threshold", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= 0.3705 THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncLowDecile",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowDecile",
(CASE WHEN c.inc_lowdecile >= 0.6548 THEN 1 ELSE 0 END) AS "VEt_Inc_LowDecile",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= 0.2656 THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncAssist",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncAssist",
(CASE WHEN c.employ_inc >= 0.4277 THEN 1 ELSE 0 END) AS "VEt_IncAssist",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= 0.7774 THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Hshld",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Hshld",
(CASE WHEN c.inc_hshld >= 0.8559 THEN 1 ELSE 0 END) AS "VEt_Hshld",

d.geom AS "geom_poly",
d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt";